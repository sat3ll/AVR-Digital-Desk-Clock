/*
 * Copyright (c) 2014, sat3ll
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, 
 * with or without modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, 
 *    this list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice, 
 * this list of conditions and the following disclaimer in the documentation and/or 
 * other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS 
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO 
 * EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT 
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, 
 * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
 
#include <avr/io.h>
#include <avr/pgmspace.h>
#include "include/libpcd8544.h"
#include "include/twi_functions.h"
#include "include/clock.h"
#include "include/text.h"


#define DS1307 0x68 /* I2C address of RTC */

static void renderdigit(uint8_t digit, uint8_t coord);
static void renderdots(uint8_t mode);
static void printnumber(uint8_t num);
static void printseparator(void);

static const uint8_t double_dots[48] PROGMEM = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0xe0, 0x07, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static const uint8_t big_numbers[10][78] PROGMEM = {
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x70, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x70, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x70, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x70, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x70, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Zero
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //One
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Two
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Three
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0x00, 0x80, 0x03, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Four
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Five
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Six
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Seven
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, //Eight
	{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0x1c, 0x80, 0x03, 0x70, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }  //Nine
	};

static const uint8_t small_numbers[10][4] PROGMEM = {
	{ 0x1F, 0x11, 0x1F, 0x00}, //Zero
	{ 0x12, 0x1F, 0x10, 0x00}, //One
	{ 0x1D, 0x15, 0x17, 0x00}, //Two
	{ 0x15, 0x15, 0x1F, 0x00}, //Three
	{ 0x07, 0x04, 0x1F, 0x00}, //Four
	{ 0x17, 0x15, 0x1D, 0x00}, //Five
	{ 0x1F, 0x15, 0x1D, 0x00}, //Six
	{ 0x01, 0x01, 0x1F, 0x00}, //Seven
	{ 0x1F, 0x15, 0x1F, 0x00}, //Eight
	{ 0x17, 0x15, 0x1F, 0x00}  //Nine
	};

static const uint8_t small_separator[6] PROGMEM = { 0b00010000, 0b00001000, 0b00000100, 0b00000010, 0b00000001, 0x00 };

/* Commands for the RTC module */
#define DS1307_SECONDS 0x00
#define DS1307_MINUTES 0x01
#define DS1307_HOURS 0x02
#define DS1307_DAY 0x03
#define DS1307_DATE 0x04
#define DS1307_MONTH 0x05
#define DS1307_YEAR 0x06

/* Fetch information from the RTC module and store it into a struct */
tempo gettime(void)
{
	tempo incoming;

	incoming.seconds = readReg(DS1307, DS1307_SECONDS) & ~0x80;
	incoming.minutes = readReg(DS1307, DS1307_MINUTES);
	incoming.hours = readReg(DS1307, DS1307_HOURS);

	incoming.day = readReg(DS1307, DS1307_DAY);
	incoming.date = readReg(DS1307, DS1307_DATE);
	incoming.month = readReg(DS1307, DS1307_MONTH);
	incoming.year = readReg(DS1307, DS1307_YEAR);
	
	return incoming;
}

/* Prints the hour and the minutes */
/* 6 - left digit of hour; 22 - right digit of hour; 50 - left digit of minutes; 65 - right digit of minutes */
void rendertime(tempo incoming)
{
	erase_full();
	renderdigit(((incoming.hours & 0x30) >> 4), 6);
	renderdigit((incoming.hours & 0x0F), 22);
	
	renderdigit(((incoming.minutes) >> 4), 50);
	renderdigit((incoming.minutes & 0x0F), 65);
	
	renderdots(incoming.seconds % 2); /* If the seconds are odd, print the separator */
}

/* Prints the current date; format is dd/mm/yy */
void printdate(tempo mydate)
{
	horizontal_mode();
	/* To print date at bottom left
	x_position(40);
	y_bank(5);
	*/
	
	/* Print at top center*/
	x_position(21);
	y_bank(0);
	PORT_LCD |= (1<<DC);
	
	printnumber((mydate.date >> 4));
	printnumber((mydate.date & 0x0F));
	printseparator();
	printnumber((mydate.month >> 4));
	printnumber((mydate.month & 0x0F));
	printseparator();
	
	/* (DS1307) YEAR ranges only from last 2 digits, 0 - 99. Year 2K has to be hardcoded */
	printnumber(2);
	printnumber(0);
	printnumber((mydate.year >> 4));
	printnumber((mydate.year & 0x0F));
}


/* Prints the slash for the date */
static void printseparator(void)
{
	for(int i = 0; i < 6; i++)
		write( pgm_read_byte(&small_separator[i]) );
}

/* Responsible for printing the digits for the date */
static void printnumber(uint8_t num)
{
	for (int j = 0; j < 4; j++)
		write( pgm_read_byte(&small_numbers[num][j]) );
}

/* The separator between the hours and the minutes */
static void renderdots(uint8_t mode)
{
	vertical_mode();
	x_position(39);
	PORT_LCD |= (1<<DC);
	
	if (mode) /* If second is odd, print separator */
	{
		for (int i = 0; i < 48; i++)
			write( pgm_read_byte(&double_dots[i]) );
	}
	else /* If second is even, dont print anything */
	{
		for (int i = 0; i < 48; i++)
			write(0x00);
	}
}

/* Responsible to render the digits for the hours and the minutes */
static void renderdigit(uint8_t digit, uint8_t coord)
{
	vertical_mode();
	x_position(coord);
	PORT_LCD |= (1<<DC);

	for (int i = 0; i < 78; i++)
		write( pgm_read_byte(&big_numbers[digit][i]) );
}

/* Prints the day of the week */
void weekday(tempo week)
{
	switch(week.day)
	{
		case 1:
			lcd_print_P(PSTR("Saturday"), 24, 5);
			break;
		case 2:
			lcd_print_P(PSTR("Sunday"), 27, 5);
			break;
		case 3:
			lcd_print_P(PSTR("Monday"), 27, 5);
			break;
		case 4:
			lcd_print_P(PSTR("Tuesday"), 24, 5);
			break;
		case 5:
			lcd_print_P(PSTR("Wednesday"), 19, 5);
			break;
		case 6:
			lcd_print_P(PSTR("Thursday"), 24, 5);
			break;
		case 7:
			lcd_print_P(PSTR("Friday"), 27, 5);
			break;
		default:
			lcd_print_P(PSTR("ERROR"), 29, 5);
	}
	origin();
}			
			
